<template>
  <div id="backGround" class="bg-slate-800 p-4 m-auto text-white rounded-lg" v-if="daData != null">
    <!-- The user icon and name table -->
    <table id="questionHead" class="text-white text-left mb-5">
      <tr>
        <td>
          <img class="rounded-full h-7 w-7 inline-block ml-2 mr-2" v-bind:src="daData['user']['avatar_url']" />
        </td>
        <td>
          <div id="user-name" class="inline-block text-base">{{ daData['user']['login']
          }}&nbsp;&nbsp;●&nbsp;&nbsp;<span class="inline-block text-xs text-slate-500">{{ daData['created_at']
            }}</span>
          </div>
        </td>
      </tr>
    </table>
    <!-- Question content -->
    <!-- TITLE -->
    <div id="title" class="text-left text-3xl font-bold mb-5">{{ daData['title'] }}</div>
    <!-- MARKDOWN BODY -->
    <div id="body" class="text-justify" v-html="daMarkDown"></div>
    <!-- <MarkDown class="text-left" :source="daMarkDown" /> -->
    <!-- <math-jax :latex="daMarkDown"></math-jax> -->
    <!-- COMMENTS COUNT -->
    <div class="text-right mt-2 text-slate-400 text-sm">{{ daData['comments'] }} Comments&nbsp;&nbsp;</div>
    <!-- Upper horizontal divider line -->
    <hr class="mb-2 mt-2 hori-sep border-slate-500">
    <!-- facebook like buttons for share, comments and view in app -->
    <div class="text-xl">
      <button v-on:click='viewInApp' id="commentsHead"
        class="inline-block text-slate-400 hover:text-white p-1 pl-5 pr-5 rounded-xl hover:bg-slate-700 w-4/12">
        <div class="material-symbols-outlined">
          phone_android
        </div>
        View in app
      </button>
      <button v-on:click='getComments' id="commentsHead"
        class="inline-block text-slate-400 hover:text-white p-1 pl-5 pr-5 rounded-xl hover:bg-slate-700 w-4/12">
        <div class="material-symbols-outlined">
          chat_bubble
        </div>
        Comments
      </button>
      <button v-on:click='share' id="commentsHead"
        class="inline-block text-slate-400 hover:text-white p-1 pl-5 pr-5 rounded-xl hover:bg-slate-700 w-4/12">
        <div class="material-symbols-outlined">
          share
        </div>
        Share
      </button>
    </div>
    <!-- Lower horizontal divider line -->
    <hr class="hori-sep mt-2 border-slate-500">
    <!-- Start of COMMENTS section -->
    <!-- COMMENTS headline -->
    <!-- when comments exist show the below tag -->
    <div id="commentsTitle" v-if="isVisible && daData['comments'] != '0'"
      class=" text-left mt-5 text-4xl text-white mb-5">
      Comments
    </div>
    <!-- when no comments exist show the below tag -->
    <div v-if="isVisible && daData['comments'] == '0'" class="text-center text-base text-slate-400 mt-5">
      No comments on this question yet!
    </div>
    <!-- the actual comments done with a v-for loop -->
    <div id="commentsSection" v-show="isVisible" v-for="(item, index) in daComments" class="ml-5 text-white text-left">
      <table id="questionHead" class="text-white text-left">
        <tr class="m-auto">
          <td>
            <img class="rounded-full h-7 w-7 inline-block mr-2" v-bind:src="item['user']['avatar_url']" />
          </td>
          <td>
            <div id="user-name" class="inline-block text-base">{{ item['user']['login']
            }}&nbsp;&nbsp;●&nbsp;&nbsp;<span class="inline-block text-xs text-slate-500">{{ item['created_at']
              }}</span>
            </div>
          </td>
        </tr>
      </table>
      <div id="body" class="text-base text-left mt-3" v-html="createCommentsMarkdown(index)"></div>
      <hr class="mb-5 mt-5 border-slate-700" v-if="index < daComments.length - 1">
    </div>
  </div>
</template>

<script>
// define math equations renderer that transforms markdown math equations into html
// that gets previewed with css rules from external file linked in the index.html
const tm = require('markdown-it-texmath');
const md = require('markdown-it')({ html: true })
  .use(tm, {
    engine: require('katex'),
    delimiters: 'dollars',
    katexOptions: { macros: { "\\RR": "\\mathbb{R}" } }
  })

export default {
  name: 'HelloWorld',
  components: {
    // 'vue3-snackbar': Vue3Snackbar
  },
  data() {
    return {
      // define the variabels that will hold the data to show
      // BODY data
      daData: null,
      daMarkDown: null,
      // COMMENTS data
      daComments: null,
      daCommentsMarkDown: null,

      // comments toggle variable
      isVisible: false,
    }
  },
  // What to do when the app just got loaded with the created function being async
  async created() {
    try {
      // Get the url of the page and get the last number in the link and extract it in a variable
      const theUrl = window.location.href.split("/")
      const pageNo = theUrl[theUrl.length - 1]
      // Fetch the data from the GITHUB API and decode its JSON into one of our variables defined above
      const theData = await fetch("https://api.github.com/repos/CrowdSolve/data/issues/" + pageNo)
      this.daData = await theData.json()

      // transform the body of the question from markdown to actual html with the marked function
      this.daMarkDown = this.daData['body']
      this.daMarkDown = md.render(this.daMarkDown);
    } catch (err) {
      console.log(err)
    }
  },
  methods: {
    recieveShow(value) {
      this.notificationShowing = value
    },
    // Define a function to fetch the comments from the GITHUB API and JSON decode it when the comments button is pressed
    async getComments() {
      // change the state of the comments section visibility on click
      this.isVisible = !this.isVisible
      if (this.isVisible) {
        const theData = await fetch(this.daData['comments_url'])
        this.daComments = await theData.json()
        window.scrollBy({
          top: 5000,
          left: 0,
          behavior: 'smooth'
        })
      }
    },
    // Define a function to change the comments look from markdown to actual text
    createCommentsMarkdown(id) {
      return md.render(this.daComments[id]['body'])
    },
    // Define a function to tell what the share button does
    share() {
      navigator.clipboard.writeText(window.location.href);
      if (screen.width >= 690) {
        this.$toast.show("Share link copied to clipboard", {
          type: 'default',
          position: 'bottom-right',
          duration: 1000
        })
      } else {
        this.$toast.show("Share link copied to clipboard", {
          type: 'default',
          position: 'bottom',
          duration: 1000
        })
      }
    },
    // Define a function to tell what the view in app button does
    viewInApp() {
      var ua = navigator.userAgent.toLowerCase()
      var isAndroid = ua.indexOf("android") > -1
      if (isAndroid) {
        window.location = "crowdsolve.page.link"
      } else {
        console.log("This is not an android device")
      }
    }
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
#backGround {
  max-width: 50rem;
  /* margin: 0rem min(100px, auto) 0rem min(100px, auto); */
}

td {
  height: 100%;
  text-align: center;
  margin: auto;
}

button {
  display: inline-flex;
  justify-content: center;
  align-items: center;
}

@media only screen and (max-width: 690px) {
  #backGround {
    padding: 0.75rem;
    width: 100vw;
    margin: 0px;
    max-width: 100%;
  }

  #title {
    text-align: justify;
    font-size: 1.3rem;
    line-height: 1.375rem;
  }

  button {
    font-size: 3vw;
  }

  button>div {
    font-size: 3vw;
  }

  .hori-sep {
    margin-top: 1vw;
    margin-bottom: 1vw;
  }

  #commentsTitle {
    font-size: 1.5rem;
  }
}

button>div {
  margin-right: 10px;
}
</style>
